From 8f197e1af780615b4ad9344ac8feed13a120cbe7 Mon Sep 17 00:00:00 2001
From: Dyneteve <dyneteve@pixelexperience.org>
Date: Tue, 22 Feb 2022 20:19:35 +0800
Subject: [PATCH] gralloc: Fix RAW10/12 buffer alignment for trinket

[Vishalcj17] Guard with TARGET_NEEDS_RAW10_BUFFER_FIX
Signed-off-by: Vishalcj17 <vishalcj@aospa.co>
Change-Id: Ic70b21180d7c8441bf794a08405fe4428a42d8ec
Signed-off-by: Skyblueborb <tomaszborbely0710@gmail.com>
---
 gralloc/Android.mk   | 3 +++
 gralloc/gr_utils.cpp | 8 ++++++++
 2 files changed, 11 insertions(+)

diff --git a/gralloc/Android.mk b/gralloc/Android.mk
index 57fee80fe2..3302ac913b 100644
--- a/gralloc/Android.mk
+++ b/gralloc/Android.mk
@@ -52,6 +52,9 @@ endif
 ifeq ($(TARGET_USES_UNALIGNED_YCRCB),true)
     LOCAL_CFLAGS              += -DUSE_UNALIGNED_YCRCB
 endif
+ifeq ($(TARGET_NEEDS_RAW10_BUFFER_FIX),true)
+LOCAL_CFLAGS                  += -DRAW10_BUFFER_FIX
+endif
 
 LOCAL_ADDITIONAL_DEPENDENCIES := $(common_deps)
 LOCAL_SRC_FILES               := gr_utils.cpp gr_adreno_info.cpp
diff --git a/gralloc/gr_utils.cpp b/gralloc/gr_utils.cpp
index 4306663ee9..4697a89053 100644
--- a/gralloc/gr_utils.cpp
+++ b/gralloc/gr_utils.cpp
@@ -1020,10 +1020,18 @@ void GetAlignedWidthAndHeight(const BufferInfo &info, unsigned int *alignedw,
       aligned_w = ALIGN(width, 16);
       break;
     case HAL_PIXEL_FORMAT_RAW12:
+#ifdef RAW10_BUFFER_FIX
+      aligned_w = ALIGN(width * 12 / 8, 8);
+#else
       aligned_w = ALIGN(width * 12 / 8, 16);
+#endif
       break;
     case HAL_PIXEL_FORMAT_RAW10:
+#ifdef RAW10_BUFFER_FIX
+      aligned_w = ALIGN(width * 10 / 8, 8);
+#else
       aligned_w = ALIGN(width * 10 / 8, 16);
+#endif
       break;
     case HAL_PIXEL_FORMAT_RAW8:
       aligned_w = ALIGN(width, 16);
-- 
2.47.0

