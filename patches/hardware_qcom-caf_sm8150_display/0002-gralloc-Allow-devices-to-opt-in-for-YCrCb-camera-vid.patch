From 285aeed73581ccc0c32c45cde9d391ace61e92ac Mon Sep 17 00:00:00 2001
From: Ivan Vecera <ivan@cera.cz>
Date: Wed, 3 Jul 2024 11:40:30 +0200
Subject: [PATCH] gralloc: Allow devices to opt-in for YCrCb camera video
 encode

DeviceAsWebcam is using USAGE_VIDEO_ENCODE [1] for buffers and
this results in combined usage: (VIDEO_ENCODER | CAMERA_OUTPUT).

On some Qcom devices (verified on pyxis (sdm710)) and maybe others
DeviceAsWebcam has red & blue colors swapped with HAL_PIXEL_FORMAT_YCbCr_420_SP_VENUS.

When using HAL_PIXEL_FORMAT_YCrCb_420_SP_VENUS the output from
DeviceAsWebcam has correct colors.

[1] https://android.googlesource.com/platform/packages/services/DeviceAsWebcam/+/d079a82ba4f773210c01d488d2dfa1d4d25be8e2

Change-Id: I4376102e2b0eeaefed536eff29c315a71e469b57
---
 gralloc/Android.mk   | 3 +++
 gralloc/gr_utils.cpp | 8 ++++++++
 2 files changed, 11 insertions(+)

diff --git a/gralloc/Android.mk b/gralloc/Android.mk
index 3302ac913b..814acddcc2 100644
--- a/gralloc/Android.mk
+++ b/gralloc/Android.mk
@@ -55,6 +55,9 @@ endif
 ifeq ($(TARGET_NEEDS_RAW10_BUFFER_FIX),true)
 LOCAL_CFLAGS                  += -DRAW10_BUFFER_FIX
 endif
+ifeq ($(TARGET_USES_YCRCB_CAMERA_ENCODE),true)
+    LOCAL_CFLAGS              += -DUSE_YCRCB_CAMERA_ENCODE
+endif
 
 LOCAL_ADDITIONAL_DEPENDENCIES := $(common_deps)
 LOCAL_SRC_FILES               := gr_utils.cpp gr_adreno_info.cpp
diff --git a/gralloc/gr_utils.cpp b/gralloc/gr_utils.cpp
index 4697a89053..9bc45ca9be 100644
--- a/gralloc/gr_utils.cpp
+++ b/gralloc/gr_utils.cpp
@@ -1333,7 +1333,15 @@ int GetImplDefinedFormat(uint64_t usage, int format) {
       } else if (usage & GRALLOC_USAGE_PRIVATE_HEIF) {
         gr_format = HAL_PIXEL_FORMAT_NV12_HEIF;
       } else if (format == HAL_PIXEL_FORMAT_YCbCr_420_888) {
+#ifdef USE_YCRCB_CAMERA_ENCODE
+        if (usage & BufferUsage::CAMERA_OUTPUT) {
+          gr_format = HAL_PIXEL_FORMAT_YCrCb_420_SP_VENUS;
+        } else {
+          gr_format = HAL_PIXEL_FORMAT_YCbCr_420_SP_VENUS;
+        }
+#else
         gr_format = HAL_PIXEL_FORMAT_YCbCr_420_SP_VENUS;
+#endif
       } else {
         gr_format = HAL_PIXEL_FORMAT_NV12_ENCODEABLE;  // NV12
       }
-- 
2.47.0

