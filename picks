#!/bin/bash

ANDROID_BUILD_TOP="$(dirname $(realpath "$0"))"
CHECK="$(echo $1 | grep -q check && echo 1)"
GERRIT_USERNAME="$(git config review.review.lineageos.org.username)"

function repopick() {
    if [[ "$CHECK" = "1" ]]; then
        echo -n "${@: -1} - " ; ssh lineage-gerrit gerrit query ${@: -1} --format=JSON | jq --slurp -r '.[0].status'
    else
        ${ANDROID_BUILD_TOP}/vendor/lineage/build/tools/repopick.py \
            -g "ssh://$GERRIT_USERNAME@review.lineageos.org:29418" $@ &
    fi
}

function repopickchain() {
    if [[ "$CHECK" = "1" ]]; then
        echo -n "$1 - " ; ssh lineage-gerrit gerrit query $1 --format=JSON | jq --slurp -r '.[0].status'
    else
        `${ANDROID_BUILD_TOP}/gen_chain $@`
    fi
}

function rc() {
    echo `${ANDROID_BUILD_TOP}/gen_chain $@ | cut -b10-`
}

#
# _examples_
#
# # repo/1
# changes=(
#     2137 # hello
#     `rc 2137` # hello (chain)
# )
# repopick ${changes[@]}
#
# # repo/2
# repopickchain 2137 # hello (chain)
#
# # repo/3
# repopick 2137 # hello
#

# build/make
# repopick -f 332045 # Don't enforce vintf kernel requirements when building without LTO

# frameworks/base
# repopick -f 357988 # Set DEFAULT_ADB_ALLOWED_CONNECTION_TIME to 0

# -- autogenerated with gen_picks (with manual fixups) --

# bionic
repopickchain 401530 # linker: Add support for dynamic SHIM libraries

# bootable/deprecated-ota
repopickchain 401533 # updater: Support loading dynamic partition metadata from OTA

# bootable/recovery
repopickchain 403877 # minui: drm: Add support for DRM_FORMAT_XRGB8888

# build/make
repopickchain 401499 # Don't copy recovery.img to BOOTABLE_IMAGES if it doesn't exist

# build/soong
repopickchain 401525 # soong: paths: Fix out of tree $OUT

# device/google/atv
repopickchain 401625 # Revert "Removing references to arm7 emulator targets."

# device/google/gs-common
repopickchain 403977 # Disable userdebug diagnostics

# device/google/gs101
repopickchain 404292 # Disable userdebug diagnostics

# device/google/gs201
repopickchain 404646 # gs201: Ignore missing system_dlkm.modules.load warning

# device/google/lynx
repopickchain 404864 # lynx: Disable userdebug diagnostics

# device/google/pantah
repopickchain 404839 # pantah: Disable userdebug diagnostics

# device/google/tangorpro
repopickchain 404879 # tangorpro: Opt out of GMS comms suite

# device/oneplus/instantnoodle
repopickchain 404885 # instantnoodle: overlay: Update pixel pitch

# device/oneplus/instantnoodlep
repopickchain 404886 # instantnoodlep: overlay: Update pixel pitch

# device/oneplus/kebab
repopickchain 404883 # kebab: overlay: Update pixel pitch

# device/oneplus/lemonade
repopickchain 404774 # lemonade: overlay: Update pixel pitch

# device/oneplus/lemonadep
repopickchain 404772 # lemonadep: overlay: Update pixel pitch

# device/oneplus/lemonades
repopickchain 404884 # lemonades: overlay: Update pixel pitch

# device/oneplus/martini
repopickchain 404773 # martini: overlay: Update pixel pitch

# device/oneplus/sm8250-common
repopickchain 404882 # sm8250-common: Sync extract scripts with 22 templates

# device/oneplus/sm8350-common
repopickchain 404714 # sm8350-common: Sync extract scripts with 22 templates

# device/samsung/gts4lv-common
repopickchain 404210 # gts4lv-common: Temporarily disable ELF checks for WFD

# device/sony/nile-common
repopickchain 404315 # nile-common: Shim libwvhidl with libcrypto_shim

# device/xiaomi/msm8996-common
repopickchain 404335 # msm8996-common: Shim widevine with libcrypto_shim

# external/arm-trusted-firmware
repopick 401626 # fix(tegra194/ras): remove incorrect erxctlr assert

# frameworks/av
repopickchain 403076 # Changing interface creation for Large audio frame

# frameworks/base
repopickchain 404723 # HidlFingerprintSensorConfig: UNKNOWN -> UNDER_DISPLAY_OPTICAL

# frameworks/native
repopickchain 402790 # input: Bring back PointerProperties::copyFrom()

# frameworks/opt/telephony
repopickchain 401683 # Revert "Clear up the obsoleted cascading signal strength polling logic"

# hardware/broadcom/libbt
repopickchain 401694 # Improve UART baud rate handling

# hardware/google/gchips
repopick 401696 # libexynosutils: Depend on device kernel headers

# hardware/google/graphics/common
repopickchain 401698 # libdrmresource: Add missing epoll_event.h include

# hardware/google/pixel
repopickchain 401705 # Restore drv2624 vibrator HAL APEX

# hardware/google/pixel-sepolicy
repopickchain 401709 # Move turbo_adapter policy out of googlebattery

# hardware/interfaces
repopickchain 404379 # fpc: Fix potential nullptr derefs

# hardware/lineage/compat
repopickchain 401141 # compat: Extend libhidlbase shim with Parcel::setData method

# hardware/qcom-caf/sm8550/audio/primary-hal
repopickchain 404030 # audio-ar: compilation fix for KS sync path change.

# hardware/qcom/audio
repopickchain 401726 # hal: Fix CFI errors

# hardware/qcom/camera
repopickchain 401732 # msm8998: use Strings8/16 empty()

# hardware/qcom/data/ipacfg-mgr
repopickchain 401735 # ipacm: Remove compilation dependency for in_addr_t on bionic

# hardware/qcom/display
repopickchain 401738 # gralloc: Fix Compilation errors

# hardware/qcom/gps
repopickchain 401740 # msm8998: Replace copy headers with header libraries

# hardware/qcom/media
repopickchain 401744 # Remove unnecessary makefile warning

# hardware/qcom/sm8150/data/ipacfg-mgr
repopick 401784 # Kernel Header Changes

# hardware/qcom/sm8150/display
repopickchain 401795 # Convert some display libraries to blueprint

# hardware/qcom/sm8150/gps
repopick 401796 # Implement xtra-daemon control via property

# hardware/qcom/sm8150/media
repopickchain 401799 # media: Drop LOCAL_COPY_HEADERS usage

# kernel/configs
repopickchain 401810 # Lower q/android-4.9 requirements

# kernel/samsung/sdm670
repopickchain 404171 # drivers: soc: qcom: Fix clang -Wasm-operand-widths warnings

# kernel/sony/sdm660
repopickchain 404320 # kbuild: clang: Disable 'asm-operand-widths warnings' warning

# kernel/xiaomi/msm8996
repopickchain 404339 # kbuild: clang: Disable 'asm-operand-widths warnings' warning

# packages/apps/Car/Settings
repopickchain 401814 # VolumeSettingsPreferenceController: Fix NPE when changing volumes

# packages/apps/LineageParts
repopickchain 404099 # LineageParts: Set fitsSystemWindows to true for PartsActivity

# packages/apps/Settings
repopickchain 402919 # NetworkProvider: Remove header start padding in SuW

# packages/apps/ThemePicker
repopickchain 402747 # Revert "Clean up unused checkmark xml files"

# packages/apps/Trebuchet
repopickchain 402832 # Trebuchet: Let's keep 2-button nav alive for a little longer

# packages/apps/TvSettings
repopickchain 402294 # Allow disabling Frame Rate settings

# packages/apps/TvSystemUI
repopick 401896 # Implement USB debugging dialog

# packages/modules/Bluetooth
repopickchain 401979 # BondStateMachine: Allow skipping confirm for some remotes

# packages/modules/Connectivity
repopickchain 403925 # netd: Limit V specific bpf progs to kernel 4.14+

# packages/modules/NetworkStack
repopick -P packages/modules/NetworkStack 404780 # ApfFilter: Skip startReadPacketFilter when counters aren't supported

# packages/modules/adb
repopickchain 401973 # adb_root: Handle Automotive builds usecase

# packages/services/Car
repopickchain 402011 # car_product: Remove non-existent pppd from PRODUCT_PACKAGES

# scripts
repopickchain 404381 # DO NOT MERGE: Android 15 beta factory images

# system/bpf
repopickchain 402599 # bpfloader: prog names are only valid on 4.15+

# system/core
repopickchain 403868 # fs_mgr: Add virtiofs to supported fs list

# system/extras
repopickchain 402054 # partition_tools: Add lpunpack_static target

# system/keymaster
repopick 402055 # Restore ImportKeyRequest::SetKeyMaterial

# system/libhidl
repopick 402056 # libhidlmemory: mark as recovery_available

# system/netd
repopickchain 402063 # Prevent DNS traffic from bypassing lockdown VPNs

# system/security
repopick 402064 # Handle key parameter conversion for FBE_ICE tag

# system/sepolicy
repopickchain 402746 # Label ro.audio.usb.period_us

# system/update_engine
repopickchain 402087 # update_engine: Add static ota_extractor target

# system/vold
repopickchain 403869 # vold: Add support for ISO9660/UDF CD-ROM

# vendor/crowdin
repopickchain 404380 # rm -rf

# vendor/lineage
repopickchain 404692 # kernel: Add rust prebuilts to path

# vendor/qcom/opensource/commonsys/fm
repopickchain 403061 # FM2: Slight design adjustments

# vendor/qcom/opensource/usb
repopickchain 403987 # hal: Make it build with -Werror

wait
