#!/bin/bash

ANDROID_BUILD_TOP="$(dirname $(realpath "$0"))"
CHECK="$(echo $1 | grep -q check && echo 1)"
GERRIT_USERNAME="$(git config review.review.lineageos.org.username)"

function repopick() {
    if [[ "$CHECK" = "1" ]]; then
        echo -n "$1 - " ; ssh lineage-gerrit gerrit query $1 --format=JSON | jq --slurp -r '.[0].status'
    else
        ${ANDROID_BUILD_TOP}/vendor/lineage/build/tools/repopick.py \
            -g "ssh://$GERRIT_USERNAME@review.lineageos.org:29418" $@ &
    fi
}

function repopickchain() {
    if [[ "$CHECK" = "1" ]]; then
        echo -n "$1 - " ; ssh lineage-gerrit gerrit query $1 --format=JSON | jq --slurp -r '.[0].status'
    else
        `${ANDROID_BUILD_TOP}/gen_chain $@`
    fi
}

function rc() {
    echo `${ANDROID_BUILD_TOP}/gen_chain $@ | cut -b10-`
}

#
# _examples_
#
# # repo/1
# changes=(
#     2137 # hello
#     `rc 2137` # hello (chain)
# )
# repopick ${changes[@]}
#
# # repo/2
# repopickchain 2137 # hello (chain)
#
# # repo/3
# repopick 2137 # hello
#

# build/make
# repopick -f 332045 # Don't enforce vintf kernel requirements when building without LTO

# frameworks/base
# repopick -f 357988 # Set DEFAULT_ADB_ALLOWED_CONNECTION_TIME to 0

# -- autogenerated with gen_picks (with manual fixups) --

# android
repopickchain 402109 # manifest: Initial changes for Android 15

# bionic
repopickchain 401530 # linker: Add support for dynamic SHIM libraries

# bootable/deprecated-ota
repopickchain 401533 # updater: Support loading dynamic partition metadata from OTA

# bootable/recovery
repopickchain 403877 # minui: drm: Add support for DRM_FORMAT_XRGB8888

# build/make
repopickchain 401499 # Don't copy recovery.img to BOOTABLE_IMAGES if it doesn't exist

# build/soong
repopickchain 401526 # check_boot_jars: Add oplus packages to whitelist

# development
repopick 401620 # make-key: Enforce PBEv1 password-protected signing keys

# device/generic/common
repopick 401621 # Compile guard aosp apns conf in gsi product

# device/google/atv
repopickchain 401625 # Revert "Removing references to arm7 emulator targets."

# device/qcom/sepolicy
repopickchain 402927 # sepolicy: add the attributes corresponding to the umdservice

# device/qcom/sepolicy_vndr/legacy-um
repopickchain 403979 # common: Switch to AIDL USB HALs

# device/qcom/sepolicy_vndr/sm8450
repopickchain 403981 # common: Switch to AIDL USB HALs

# device/qcom/sepolicy_vndr/sm8550
repopickchain 403983 # common: Switch to AIDL USB HALs

# external/ant-wireless/hidl
repopick 402928 # Add .gitupstream file

# external/arm-trusted-firmware
repopick 401626 # fix(tegra194/ras): remove incorrect erxctlr assert

# external/avb
repopickchain 401628 # avbtool: Add retry to generate_fec_data()

# external/cronet
repopick 401629 # cronet: Fix build with custom out directory

# external/dtc
repopickchain 401641 # Add build support for more host utils

# external/e2fsprogs
repopickchain 401644 # e2fsck: Loosen fscrypt_policy struct size check

# external/gptfdisk
repopickchain 401653 # gptfdisk: Make libsgdisk visible to libvolume_manager

# external/json-c
repopickchain 402932 # libjson: Convert makefile to blueprint

# external/mksh
repopickchain 401656 # mksh: Set TERM to xterm-256color

# external/robolectric
repopick 401657 # Fix Trebuchet tests

# external/setupcompat
repopickchain 401664 # Change some more defaults

# external/tinycompress
repopickchain 403295 # tinycompress: Add conditional compilation check for compress param

# external/zstd
repopickchain 401669 # zstd: Android.bp: Allow rsync to add zstd compression support

# frameworks/av
repopickchain 403076 # Changing interface creation for Large audio frame

# frameworks/base
repopickchain 404088 # SystemUI: screenshot: close QS after launching long screenshot activity

# frameworks/libs/systemui
repopick 401670 # ClockDrawableWrapper: Set DISABLE_SECONDS to false

# frameworks/native
repopickchain 402790 # input: Bring back PointerProperties::copyFrom()

# frameworks/opt/calendar
repopick 401671 # fix invalid time being set when `Time.set(Time)` is being called on itself

# frameworks/opt/colorpicker
repopick 401672 # Migrate to androidx

# frameworks/opt/telephony
repopickchain 401683 # Revert "Clear up the obsoleted cascading signal strength polling logic"

# frameworks/opt/timezonepicker
repopickchain 401686 # Migrate to androidx fragment library

# hardware/broadcom/libbt
repopickchain 401694 # Improve UART baud rate handling

# hardware/google/camera
repopick 401695 # camera: Guard with soong namespace

# hardware/google/gchips
repopick 401696 # libexynosutils: Depend on device kernel headers

# hardware/google/graphics/common
repopickchain 401698 # libdrmresource: Add missing epoll_event.h include

# hardware/google/pixel
repopickchain 401705 # Restore drv2624 vibrator HAL APEX

# hardware/google/pixel-sepolicy
repopickchain 401709 # Move turbo_adapter policy out of googlebattery

# hardware/interfaces
repopickchain 401720 # compatibility_matrices: Add p/android-4.4 into FCM 5

# hardware/libhardware
repopickchain 401723 # libhardware: Add new display types.

# hardware/lineage/compat
repopickchain 401141 # compat: Extend libhidlbase shim with Parcel::setData method

# hardware/qcom-caf/bootctrl
repopickchain 403577 # aidl: Use libboot_control_qti_defaults instead of shared lib

# hardware/qcom-caf/common
repopickchain 403502 # qcom: Add soong config for thermal HAL

# hardware/qcom-caf/sm8450/audio/primary-hal
repopickchain 404027 # Add missing libarpal_headers includes

# hardware/qcom-caf/sm8550/audio/primary-hal
repopickchain 404030 # audio-ar: compilation fix for KS sync path change.

# hardware/qcom-caf/thermal
repopickchain 403401 # thermal-hal: Add back support for legacy SoCs

# hardware/qcom/audio
repopickchain 401726 # hal: Fix CFI errors

# hardware/qcom/camera
repopickchain 401732 # msm8998: use Strings8/16 empty()

# hardware/qcom/data/ipacfg-mgr
repopickchain 401735 # ipacm: Remove compilation dependency for in_addr_t on bionic

# hardware/qcom/display
repopickchain 401738 # gralloc: Fix Compilation errors

# hardware/qcom/gps
repopickchain 401740 # msm8998: Replace copy headers with header libraries

# hardware/qcom/media
repopickchain 401744 # Remove unnecessary makefile warning

# hardware/qcom/sm7250/display
repopickchain 401777 # Convert some display libraries to blueprint

# hardware/qcom/sm7250/gps
repopickchain 401779 # gps: Remove gps.conf

# hardware/qcom/sm7250/media
repopickchain 401782 # media: Drop LOCAL_COPY_HEADERS usage

# hardware/qcom/sm8150/data/ipacfg-mgr
repopick 401784 # Kernel Header Changes

# hardware/qcom/sm8150/display
repopickchain 401795 # Convert some display libraries to blueprint

# hardware/qcom/sm8150/gps
repopick 401796 # Implement xtra-daemon control via property

# hardware/qcom/sm8150/media
repopickchain 401799 # media: Drop LOCAL_COPY_HEADERS usage

# hardware/qcom/wlan
repopickchain 403992 # wifi_hal: Fix conversion from string literal to 'char *' error
repopick 401800 # Resolve compilation error for fib_rule_port_range with fib_rules.h

# hardware/ril
repopick 401801 # libril: allow board to provide libril

# hardware/samsung/nfc
repopick 401802 # Add vendor prefix and change service name

# hardware/st/nfc
repopickchain 401804 # Add support to read different fw configs for ssss/dsds

# kernel/configs
repopickchain 401810 # Lower q/android-4.9 requirements

# lineage-sdk
repopickchain 403525 # sdk: Add GLOBAL_ACTION_KEY_SYSTEM_UPDATE

# packages/apps/Camera2
repopick 401811 # Override Aperture app

# packages/apps/Car/Settings
repopickchain 401814 # VolumeSettingsPreferenceController: Fix NPE when changing volumes

# packages/apps/CellBroadcastReceiver
repopick 401815 # CellBroadcastReceiver: Bring in the new icon

# packages/apps/Contacts
repopickchain 401833 # Contacts: MD3-ify more

# packages/apps/DocumentsUI
repopickchain 401838 # DocumentsUI: fix crash in desktop/tablet mode when selecting files

# packages/apps/EmergencyInfo
repopickchain 401840 # Fix activity name for EmergencyGestureAction

# packages/apps/Messaging
repopickchain 402745 # Messaging: FrameSequence -> ImageDecoder

# packages/apps/Nfc
repopick 401873 # Nfc: Bring in the new icon

# packages/apps/Settings
repopickchain 402902 # Settings: Hide Flashlight
repopickchain 402919 # NetworkProvider: Remove header start padding in SuW

# packages/apps/SettingsIntelligence
repopickchain 401877 # Style search bar to match new Settings UI

# packages/apps/Stk
repopick 401878 # Stk: Bring in the new icon

# packages/apps/Tag
repopick 401879 # Tag: Bring in the new icon

# packages/apps/ThemePicker
repopickchain 402747 # Revert "Clean up unused checkmark xml files"

# packages/apps/Trebuchet
repopickchain 402832 # Trebuchet: Let's keep 2-button nav alive for a little longer

# packages/apps/TvSettings
repopickchain 402294 # Allow disabling Frame Rate settings

# packages/apps/TvSystemUI
repopick 401896 # Implement USB debugging dialog

# packages/apps/WallpaperPicker2

# packages/inputmethods/LatinIME
repopickchain 401968 # LatinIME: Update emojis

# packages/inputmethods/LeanbackIME
repopick 401969 # LeanbackIME: Bring in the new icon

# packages/modules/Bluetooth
repopickchain 401979 # BondStateMachine: Allow skipping confirm for some remotes

# packages/modules/Connectivity
repopickchain 403925 # netd: Limit V specific bpf progs to kernel 4.14+

# packages/modules/Permission
repopickchain 401994 # PermissionController: Enable usage timeline for all permission groups

# packages/modules/Wifi
repopick 401995 # Wifi: Ingore miracast scan from connectivity manager

# packages/modules/adb
repopickchain 401973 # adb_root: Handle Automotive builds usecase

# packages/modules/common
repopick 401980 # Make adbroot_aidl_interface-ndk available for adbd

# packages/providers/BlockedNumberProvider
repopick 401996 # BlockedNumberProvider: Bring in the new icon

# packages/providers/BookmarkProvider
repopick 401997 # BookmarkProvider: Bring in the new icon

# packages/providers/CalendarProvider
repopick 401998 # CalendarProvider: Bring in the new icon

# packages/providers/CallLogProvider
repopick 401999 # CallLogProvider: Bring in the new icon

# packages/providers/ContactsProvider
repopick 402000 # ContactsProvider: Bring in the new icon

# packages/providers/DownloadProvider
repopickchain 402003 # DownloadProvider: Add support for manual pause/resume

# packages/providers/MediaProvider
repopickchain 402005 # MediaProvider: Less spam

# packages/providers/TelephonyProvider
repopickchain 402007 # TelephonyProvider: add upgrade support from lineage-17.1

# packages/screensavers/PhotoTable
repopick 402008 # PhotoTable: Bring in the new icon

# packages/services/Car
repopickchain 402011 # car_product: Remove non-existent pppd from PRODUCT_PACKAGES

# packages/services/Mms
repopickchain 402013 # Mms: Bring in the new icon

# packages/services/Telecomm
repopickchain 402016 # CallLog: Get rid of warning

# packages/services/Telephony
repopickchain 402021 # Telephony: Add ERI configuration for U.S. Cellular

# packages/wallpapers/LivePicker
repopick 402022 # LivePicker: Bring in the new icon

# system/bpf
repopickchain 402599 # bpfloader: prog names are only valid on 4.15+

# system/core
repopickchain 403868 # fs_mgr: Add virtiofs to supported fs list

# system/extras
repopickchain 402054 # partition_tools: Add lpunpack_static target

# system/keymaster
repopick 402055 # Restore ImportKeyRequest::SetKeyMaterial

# system/libhidl
repopick 402056 # libhidlmemory: mark as recovery_available

# system/libziparchive
repopick 402057 # ziptool: restore unzip for recovery

# system/logging
repopickchain 402059 # liblog: Always report as debuggable when building userdebug/eng

# system/media
repopick 402060 # media: update path for vendor specific config files

# system/netd
repopickchain 402063 # Prevent DNS traffic from bypassing lockdown VPNs

# system/security
repopick 402064 # Handle key parameter conversion for FBE_ICE tag

# system/sepolicy
repopickchain 402746 # Label ro.audio.usb.period_us

# system/tools/mkbootimg
repopick 402079 # mkbootimg: add support for --dt

# system/update_engine
repopickchain 402087 # update_engine: Add static ota_extractor target

# system/vold
repopickchain 403869 # vold: Add support for ISO9660/UDF CD-ROM

# tools/extract-utils
repopickchain 403960 # extract_utils: Remove TARGET_DISABLE_XML_FIXING

# vendor/codeaurora/telephony
repopickchain 402937 # IMS: Add Motorola specific API for VT

# vendor/lineage
repopickchain 403971 # kernel: Update default clang version to r522817

# vendor/qcom/opensource/audio-hal/st-hal-ar
repopickchain 403430 # STHAL: Add null pointer check

# vendor/qcom/opensource/commonsys-intf/display
repopickchain 402942 # Partially revert gralloc struct changes

# vendor/qcom/opensource/commonsys/display
repopickchain 402950 # commonsys: services: Delete device_obj_ to release the memory

# vendor/qcom/opensource/commonsys/fm
repopickchain 403061 # FM2: Slight design adjustments

# vendor/qcom/opensource/commonsys/wfd
repopickchain 403436 # libwfdaac_vendor: Build with -Werror

# vendor/qcom/opensource/core-utils-sys
repopick 403000 # Add .gitupstream file

# vendor/qcom/opensource/core-utils-vendor
repopickchain 403438 # fwd-detect: Create symlink target for CneApp

# vendor/qcom/opensource/healthd-ext
repopickchain 403440 # healthd-ext: update AIDL HAL version to 3

# vendor/qcom/opensource/interfaces
repopickchain 403008 # IUMDAdaptor: Add interface to enable umd-daemon

# vendor/qcom/opensource/power
repopick -p 403441 # Merge tag 'LA.VENDOR.14.3.0.r1-16800-lanai.QSSI15.0' into staging/lineage-22.0_merge-LA.VENDOR.14.3.0.r1-16800-lanai.QSSI15.0

# vendor/qcom/opensource/usb
repopickchain 403987 # hal: Make it build with -Werror

# vendor/qcom/opensource/vibrator
repopickchain 404019 # vibrator: Build with -Werror

wait
